// 直接在脚本中定义文本数据库
const articles = {
    integrated_writing: [
        "The reading and the lecture are about methods to protect peregrine falcon populations. The author feels that we can do this by protecting their habitats, controlling their predators and helping injured falcons. The lecturer does not believe that these methods will protect falcon populations.First of all, the author argues that we can protect their nesting areas, which are usually located on the sides of cliffs or tall buildings, from human activities. According to the article, it is possible to collaborate with developers to ensure that the birds have plenty of room to raise their young. On the other hand, the lecturer says that it is very hard to identify and locate nesting sites, since they are often located on private property. Moreover, it is hard to balance the needs of the falcons and humans, since they often nest in urban areas.Second, according to the article, we could assist the falcons by controlling the populations of their predators. The author suggests using non-lethal methods to achieve this, or even relocating them in some cases. The lecturer challenges this idea as well. He notes that there could be unintended consequences of using this approach. He thinks that if we reduce the population of one species of predator, we could inadvertently increase the population of some other predator, which would put the falcons at risk.Finally, the author suggests treating and rehabilitating injured or sick falcons that have been affected by pollution or interference by humans. After treating these birds we can release them back into the wild. In contrast, the lecturer notes that this is an expensive and time-consuming process, and is only good for individual birds. He argues that other factors have a much bigger impact on the overall population, so treating individual birds may not be effective.",
        "The reading and the lecture are about whether or not having a lot of choices in our lives is advantageous.  The author feels that this phenomenon is actually a good thing.  On the other hand, the lecturer believes that it can cause serious problems for people and society. First of all, the author notes that nowadays we are more likely to find goods and services that perfectly meet our needs because there are many options in the marketplace.  This makes our lives easier and it means that we are not likely to regret our choices in life.  In contrast, the professor says that it can be extremely tiring to evaluate all of the options that are available.  He says that this can lead to a problem called “decision fatigue,” which refers to how it is harder to make good decisions as the day goes on. Next, the article suggests that the availability of many choices leads to innovation in society.  Our tendency to always seek out newer and better options forces companies to produce better goods.  The professor also challenges this point.  He argues that in reality this just causes the marketplace to fill up with mediocre products.  Eventually, this may hinder the overall progress of society. Finally, it is noted in the article that having many choices  increases our individual growth and development.  This is because we reflect on ourselves and our values when we consider what products to choose.  The professor challenges this argument by saying that this actually causes us to become complacent and lazy.  In fact, we may not seek out more options if we feel that everything we need is already available to us.  As a result, we achieve less success in our personal and professional lives.",
        "The article and the lecture are about whether or not the Phoenicians circumnavigated Africa. While the author of the reading argues that the Phoenicians could not have undertaken such a voyage, the lecturer believes that they were capable of completing this journey. First, the author argues that the Phoenician ships were small and made of wood, and lacked navigational equipment. The article states that they would not have been able to withstand the powerful currents and storms of the open ocean. However, the lecturer’s counterargument is that the Phoenician ships were surprisingly sturdy and well-equipped for long voyages. Their wooden hulls were reinforced with metal plates that made them extremely durable, and Phoenician sailors were skilled in repairing and maintaining their ships while at sea. Secondly, the author argues that the Cape of Good Hope, located at the southern tip of Africa, is well-known for its strong currents and unpredictable weather, making it a challenging region for navigation. In contrast, the lecturer argues that the Phoenicians were skilled navigators who were able to use the stars and other natural landmarks to navigate the open ocean. Additionally, since the Phoenicians set up trading posts along the West African coast, they could have learned about the local geography and currents from residents. Finally, the article notes that there are no surviving records or artifacts that clearly prove that the Phoenicians ever attempted to circumnavigate Africa. However, the lecturer points to indirect historical records like ancient Egyptian drawings that seem to depict Phoenician ships passing along the coast of North Africa. He also mentions texts by ancient Greek historians that refer to Phoenician sailors completing a voyage around the continent.",
        "The reading and lecture are both about the Cave of the Hands, a famous archeological site in Argentina.  The article describes three possible reasons why early humans left hand prints in the cave.  The lecturer, however, believes that the author’s theories are flawed. First, the author notes that the handprints might represent a primitive alphabet. According to the article, handprints of different sizes might have different meanings, and the arrangement of the hands could convey additional meanings.  The lecturer, on the other hand, says that this is unlikely.  He notes that the various sizes might just reflect artistic intentions and that experts haven’t found any patterns in the arrangement of the prints.  Since all alphabets contain logical patterns, it is unlikely that the handprints were used in this way. Secondly, the author suggests that the cave might have had religious significance.  People might have left the prints during important religious ceremonies.  The lecturer casts doubt on this suggestion.  He says that no traces of religious ceremonies have been found in the cave.  If ceremonies had been held there, archeologists would have found some sculptures or pottery. Finally, the author theorizes that the handprints are related to hunting, as the cave is located near places where early humans used to hunt.  The article notes that the handprints might be a record of successful hunts.  Prehistoric people are known to have frequently made records of this sort.  The lecturer says that while it is true that the cave is located near a former hunting ground, most early humans recorded hunting activities using pictures of actual animals.  Since such images are not found in this cave, the author’s theory is unconvincing."
    ],
    academic_discussion: [
        "I strongly advocate for the imposition of taxes on unhealthy products. I completely align with Sam's belief that such taxes could significantly reduce the prevalence of major health issues in society. Additionally, I propose that a portion of the revenue generated from these taxes should be directed towards health and nutrition research and development. This could include funding for studies that investigate the impact of unhealthy foods, the development of healthier food alternatives, and the discovery of new strategies to promote better dietary habits across different population segments. Investing in this research could yield long-term solutions and insights crucial for tackling dietary-related health problems. Tanya raised a concern about the possibility of individuals opting for lower-quality goods as a cost-saving measure, but she overlooked the potential for government interventions such as subsidies, incentives, or support programs aimed at making healthier food options more accessible and affordable. By implementing these measures alongside the unhealthy food tax, it ensures that nutritious alternatives are available, preventing people from turning to inferior quality products.",
        "From my perspective, students should be given grades. Grades, when accompanied by constructive feedback, offer valuable insights into a student's performance. This feedback is crucial for learning and development as it guides students in understanding their mistakes and learning from them. It also provides a roadmap for both students and teachers to focus their efforts more effectively. By highlighting strengths and weaknesses, grades combined with feedback can significantly enhance a student's learning experience. While it's true that grades can foster competition, this isn't inherently negative. Competition, when framed positively, can motivate students to strive for excellence and can prepare them for real-world scenarios where performance is often measured against peers. The key is to balance this with collaborative learning opportunities that emphasize teamwork and collective achievement, showing that individual success does not have to come at the expense of others.",
        "I am deeply convinced of the vast benefits that social media brings to the table. I fully agree with Mark's view that social media has the power to uplift voices that have traditionally been ignored, offering them a platform for expression. Beyond this, social media serves as a cost-effective and efficient way for businesses to engage with their audience, showcase their products or services, and expand their market reach. The influence of user-generated content, such as reviews and personal narratives, is pivotal in guiding consumer decisions, thereby building trust and loyalty towards a brand. This vibrant interactive space allows businesses to flourish and adapt within the constantly evolving digital landscape. While Sarah highlighted the impact of social media on youth mental health, she overlooked the possibility of mitigating these issues. Implementing more rigorous policies and reporting systems is crucial. Fostering digital literacy and empathy among users, raising awareness of the consequences of online behavior, and offering mental health support resources can help cultivate a more secure and supportive online community.",
        "Personally, I don't see targeted advertising as a matter of ethical concern. Echoing Mike's sentiment, I believe individuals have the choice to opt-out if targeted advertising does not sit well with them. I'd like to add that targeted advertising offers a strategic advantage to businesses through the personalization of advertising messages. This personalization significantly enhances the likelihood of a message striking a chord with consumers on an individual basis. In turn, this fosters stronger and more meaningful connections between brands and their customers, leading to improved engagement, fostering brand loyalty, and potentially boosting sales and customer retention. Jessica pointed out the necessity for companies to craft advertisements that appeal to a broad audience. However, she overlooked the fact that as more brands lean into targeted advertising, those sticking exclusively to general advertising strategies risk losing their competitive advantage. Such brands may become out of touch or irrelevant to modern consumers who prefer personalized content."
    ]
};

// 获取所有需要的DOM元素
const textDisplay = document.getElementById('text-display');
const inputArea = document.getElementById('input-area');
const timeElement = document.getElementById('time');
const wpmElement = document.getElementById('wpm');
const startButton = document.getElementById('start-btn');
const pauseButton = document.getElementById('pause-btn');
const resetButton = document.getElementById('reset-btn');
const endButton = document.getElementById('end-btn');
const difficultySelect = document.getElementById('difficulty');
const customTextArea = document.getElementById('custom-text');
const resultDiv = document.getElementById('result');
const errorDisplay = document.getElementById('error-display');
const totalTimeElement = document.getElementById('total-time');
const finalWpmElement = document.getElementById('final-wpm');
const prevPageButton = document.getElementById('prev-page');
const nextPageButton = document.getElementById('next-page');

// 检查DOM元素是否正确获取
console.log('DOM elements:', {
    textDisplay, inputArea, startButton, difficultySelect, customTextArea
});

// 初始化变量
let startTime, endTime, timerInterval;
let originalText = '';
let isTyping = false;
let isPaused = false;
let elapsedTime = 0;
let currentPage = 0;
let textPages = [];
let totalWords = 0;

// 获取随机文本
function getRandomText(category) {
    console.log('Getting random text for category:', category);
    if (category === 'custom') {
        return customTextArea.value.trim().replace(/\\/g, '');
    }
    const selectedTexts = articles[category];
    if (!selectedTexts || selectedTexts.length === 0) {
        console.error('No texts available for category:', category);
        return '没有可用的文本';
    }
    const randomText = selectedTexts[Math.floor(Math.random() * selectedTexts.length)];
    console.log('Selected random text:', randomText);
    return randomText;
}

// 将文本分割成页面
function splitTextIntoPages(text, wordsPerPage = 150) {
    console.log('Splitting text into pages');
    const words = text.split(/\s+/);
    totalWords = words.length;
    const pages = [];
    for (let i = 0; i < words.length; i += wordsPerPage) {
        pages.push(words.slice(i, i + wordsPerPage).join(' '));
    }
    console.log('Total pages:', pages.length);
    return pages;
}

// 显示当前页面
function displayCurrentPage() {
    console.log('Displaying current page:', currentPage);
    if (textPages.length > 0) {
        textDisplay.textContent = textPages[currentPage];
        console.log('Text display content:', textDisplay.textContent);
        prevPageButton.disabled = currentPage === 0;
        nextPageButton.disabled = currentPage === textPages.length - 1;
        document.getElementById('current-page').textContent = currentPage + 1;
        document.getElementById('total-pages').textContent = textPages.length;
    } else {
        textDisplay.textContent = '没有可显示的文本';
        console.error('No text pages available');
    }
}

// 开始打字
function startTyping() {
    console.log('Starting typing');
    if (!isTyping) {
        isTyping = true;
        isPaused = false;
        inputArea.value = '';
        inputArea.disabled = false;
        startButton.style.display = 'none';
        pauseButton.style.display = 'inline-block';
        endButton.style.display = 'inline-block';
        difficultySelect.disabled = true;
        customTextArea.disabled = true;
        
        const selectedCategory = difficultySelect.value;
        console.log('Selected category:', selectedCategory);
        originalText = getRandomText(selectedCategory);
        console.log('Original text:', originalText);
        
        textPages = splitTextIntoPages(originalText);
        console.log('Text pages:', textPages);
        currentPage = 0;
        displayCurrentPage();
        startTime = new Date();
        timerInterval = setInterval(updateTimer, 1000);
        inputArea.focus();
        resultDiv.style.display = 'none';
        errorDisplay.innerHTML = '';
        document.getElementById('total-words').textContent = totalWords;
    }
}

// 暂停打字
function pauseTyping() {
    console.log('Pausing typing');
    if (isTyping && !isPaused) {
        isPaused = true;
        clearInterval(timerInterval);
        inputArea.disabled = true;
        pauseButton.textContent = '继续';
    } else if (isTyping && isPaused) {
        isPaused = false;
        startTime = new Date() - elapsedTime * 1000;
        timerInterval = setInterval(updateTimer, 1000);
        inputArea.disabled = false;
        pauseButton.textContent = '暂停';
        inputArea.focus();
    }
}

// 重置打字
function resetTyping() {
    console.log('Resetting typing');
    isTyping = false;
    isPaused = false;
    clearInterval(timerInterval);
    inputArea.value = '';
    inputArea.disabled = true;
    startButton.style.display = 'inline-block';
    pauseButton.style.display = 'none';
    endButton.style.display = 'none';
    pauseButton.textContent = '暂停';
    difficultySelect.disabled = false;
    customTextArea.disabled = false;
    textDisplay.textContent = '点击"开始"按钮开始练习';
    timeElement.textContent = '0';
    wpmElement.textContent = '0';
    document.getElementById('total-words').textContent = '0';
    document.getElementById('current-page').textContent = '0';
    document.getElementById('total-pages').textContent = '0';
    elapsedTime = 0;
    resultDiv.style.display = 'none';
}

// 结束打字
function endTyping() {
    console.log('Ending typing');
    if (isTyping) {
        isTyping = false;
        isPaused = false;
        clearInterval(timerInterval);
        inputArea.disabled = true;
        startButton.style.display = 'inline-block';
        pauseButton.style.display = 'none';
        endButton.style.display = 'none';
        
        // 计算最终结果
        const totalTime = Math.floor((new Date() - startTime) / 1000);
        const typedWords = inputArea.value.trim().split(/\s+/).length;
        const wpm = Math.round((typedWords / totalTime) * 60);
        const errors = countErrors(inputArea.value, originalText);
        
        // 显示结果
        resultDiv.style.display = 'block';
        document.getElementById('total-time').textContent = totalTime;
        document.getElementById('final-wpm').textContent = wpm;
        document.getElementById('total-errors').textContent = errors;
        
        // 显示错误
        showErrors();
    }
}

// 计算错误数
function countErrors(typed, original) {
    const typedWords = typed.trim().split(/\s+/);
    const originalWords = original.trim().split(/\s+/);
    let errors = 0;
    
    for (let i = 0; i < Math.max(typedWords.length, originalWords.length); i++) {
        if (typedWords[i] !== originalWords[i]) {
            errors++;
        }
    }
    
    return errors;
}

// 显示错误
function showErrors() {
    const typedWords = inputArea.value.trim().split(/\s+/);
    const originalWords = originalText.trim().split(/\s+/);
    let errorHtml = '';
    
    for (let i = 0; i < Math.max(typedWords.length, originalWords.length); i++) {
        if (i < originalWords.length) {
            if (i < typedWords.length && typedWords[i] === originalWords[i]) {
                errorHtml += `<span class="correct">${originalWords[i]}</span> `;
            } else {
                errorHtml += `<span class="error">${originalWords[i]}</span> `;
            }
        }
    }
    
    errorDisplay.innerHTML = errorHtml;
}

// 更新计时器
function updateTimer() {
    const currentTime = new Date();
    elapsedTime = Math.floor((currentTime - startTime) / 1000);
    timeElement.textContent = elapsedTime;
    updateWPM();
}

// 更新WPM
function updateWPM() {
    const typedWords = inputArea.value.trim().split(/\s+/).length;
    const minutes = elapsedTime / 60;
    const wpm = Math.round(typedWords / minutes);
    wpmElement.textContent = wpm;
}

// 事件监听器
startButton.addEventListener('click', startTyping);
pauseButton.addEventListener('click', pauseTyping);
resetButton.addEventListener('click', resetTyping);
endButton.addEventListener('click', endTyping);

difficultySelect.addEventListener('change', function() {
    console.log('Difficulty changed:', this.value);
    if (this.value === 'custom') {
        customTextArea.style.display = 'block';
    } else {
        customTextArea.style.display = 'none';
    }
    // 每次选择改变时重置打字区域
    resetTyping();
});

// 添加翻页功能
prevPageButton.addEventListener('click', function() {
    if (currentPage > 0) {
        currentPage--;
        displayCurrentPage();
    }
});

nextPageButton.addEventListener('click', function() {
    if (currentPage < textPages.length - 1) {
        currentPage++;
        displayCurrentPage();
    }
});

// 初始化页面状态
resetTyping();

console.log('Script loaded and initialized');
